@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.Extensions.Options
@using Starbender.RecipeApp.Blazor.Components.Button
@using Starbender.RecipeApp.Services.Contracts.Authorization

@inherits RecipeComponentBase

<MudPaper Class="pa-3">
    <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
        <MudText Typo="Typo.h6">Recipes</MudText>
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
            
            @if (_options.EnableSeeding && _canCreateRecipes)
            {
                <SeedButton />
            }

            @if (_canCreateRecipes)
            {
                <CreateRecipeButton HandleDialogSavedAsync="HandleRecipeCreatedAsync" />
            }
            
            @if(CanCollapse)
            {
                <MudIconButton 
                    Icon="@(_isExpanded ? Icons.Material.Filled.ExpandLess : Icons.Material.Filled.ExpandMore)"
                    Color="Color.Default"
                    Size="Size.Small"
                    OnClick="ToggleExpanded"
                    aria-label="Toggle recipes" />
            }

        </MudStack>
    </MudStack>

    <MudCollapse Expanded=@(!CanCollapse || _isExpanded)>
        <MudTextField T="string"
                      Label="Search recipes"
                      Placeholder="Search title or description"
                      Variant="Variant.Outlined"
                      Margin="Margin.Dense"
                      Immediate="true"
                      @bind-Value="_searchTerm" />

        @foreach(var recipeId in FilteredRecipeIds)
        {
            <RecipeItem RecipeId="@recipeId" 
                OnDelete="HandleRecipeDeleteAsync" 
                IsEditable="IsEditable"/>            
        }

    </MudCollapse>
</MudPaper>

@code {
    [Inject] IRecipeAppService RecipeService { get; set; } = default!;
    [Inject] IOptions<RecipeAppOptions> Options { get; set; } = default!;
    [Inject] IDialogService DialogService { get; set; } = default!;
    [Inject] AuthenticationStateProvider AuthenticationStateProvider { get; set; } = default!;

    [Parameter] public bool CanCollapse { get; set; } = false;
    [Parameter] public bool IsEditable { get; set; } = true;

    private List<RecipeDto> _recipes = new();
    private readonly Dictionary<int, int> _imageRefresh = new();
    private string _searchTerm = string.Empty;
    private RecipeAppOptions _options = new();
    private bool _isExpanded = true;
    private bool _canCreateRecipes;

    private void ToggleExpanded() =>
        _isExpanded = !_isExpanded;

    private IEnumerable<RecipeDto> FilteredRecipes =>
        string.IsNullOrWhiteSpace(_searchTerm)
            ? _recipes
            : _recipes.Where(recipe =>
                (recipe.Title?.Contains(_searchTerm, StringComparison.OrdinalIgnoreCase) ?? false) ||
                (recipe.Description?.Contains(_searchTerm, StringComparison.OrdinalIgnoreCase) ?? false));

    private List<int> FilteredRecipeIds => 
        FilteredRecipes.Select(t => t.Id).ToList();

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        _canCreateRecipes = RecipeAuthorizationEvaluator.HasPermission(authState.User, RecipeAppPermissions.ManageOwnedRecipe);
        _recipes = (await RecipeService.GetAllAsync()).ToList();
        _options = Options.Value;

        await base.OnInitializedAsync();
    }

    private void HandleRecipeDeleteAsync(int recipeId)
    {
        var item = _recipes.FirstOrDefault(t => t.Id == recipeId);

        if (item != null)
        {
            _recipes.Remove(item);
        }
    }

    private async Task HandleRecipeCreatedAsync(RecipeDto newItem)
    {
        try
        {
            var savedItem = await RecipeService.CreateAsync(newItem);
            _recipes.Insert(0, savedItem);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Create failed: {ex.Message}", Severity.Error);
        }
    }
}
